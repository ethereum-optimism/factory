name: Docker Build (Reusable)
# Supports both docker build and docker bake modes

on:
  workflow_call:
    inputs:
      # === Common inputs ===
      mode:
        description: 'Build mode: "build" for Dockerfile, "bake" for docker-bake.hcl'
        required: false
        type: string
        default: 'build'
      registry:
        description: 'Container registry URL (e.g., us-docker.pkg.dev/project/repo)'
        required: true
        type: string
      image_name:
        description: 'Image name (e.g., gateway-backend)'
        required: true
        type: string
      target:
        description: 'Docker build target (for multi-stage Dockerfiles) or bake target'
        required: false
        type: string
        default: ''
      gcp_project_id:
        description: 'GCP Project ID'
        required: false
        type: string
      tag:
        description: 'Docker tag for the final image'
        required: false
        type: string
        default: ${{ github.ref_name }}
      skip_arm64:
        description: 'Skip ARM64 builds (build amd64 only)'
        required: false
        type: boolean
        default: false
      env:
        description: 'Environment variables to set before build (KEY=VALUE format, one per line)'
        required: false
        type: string
        default: ''

      # === Source repository inputs ===
      source_repo:
        description: 'Source repository to build from (format: owner/repo). If empty, uses the calling workflow repository with git context.'
        required: false
        type: string
        default: ''
      source_ref:
        description: 'Git ref (branch, tag, SHA) to checkout from source_repo. Only used when source_repo is specified.'
        required: false
        type: string
        default: ''

      # === Build mode inputs ===
      context:
        description: '[build mode] Build context path'
        required: false
        default: '.'
        type: string
      dockerfile:
        description: '[build mode] Path to Dockerfile relative to context'
        required: false
        type: string
        default: 'Dockerfile'
      build_args:
        description: '[build mode] Build arguments as multiline string (KEY=VALUE format, one per line)'
        required: false
        type: string
        default: ''

      # === Bake mode inputs ===
      bake_file:
        description: '[bake mode] Path to docker-bake.hcl or docker-compose.yml file'
        required: false
        type: string
        default: 'docker-bake.hcl'
      set:
        description: '[bake mode] Variables to set (KEY=VALUE format, one per line)'
        required: false
        type: string
        default: ''

    secrets:
      source_token:
        description: 'Token for accessing source_repo when it is a private repository'
        required: false

jobs:
  safety-checklist:
    runs-on: ubuntu-latest
    outputs:
      sanitized_tag: ${{ steps.sanitize.outputs.sanitized_tag }}
      is_fork_pr: ${{ steps.fork-check.outputs.is_fork_pr }}
    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Sanitize tag
        id: sanitize
        run: echo "sanitized_tag=$(echo ${{ inputs.tag }} | sed 's/[^a-zA-Z0-9.]/-/g')" >> $GITHUB_OUTPUT
      - name: Check if we are in a fork PR
        id: fork-check
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" && "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]]; then
            echo "is_fork_pr=true" >> $GITHUB_OUTPUT
          else
            echo "is_fork_pr=false" >> $GITHUB_OUTPUT
          fi

  build:
    needs: safety-checklist
    strategy:
      fail-fast: true
      matrix:
        include: ${{ fromJSON(inputs.skip_arm64 && '[{"platform":"linux/amd64","runner":"ubuntu-latest"}]' || '[{"platform":"linux/amd64","runner":"ubuntu-latest"},{"platform":"linux/arm64","runner":"ubuntu-24.04-arm"}]') }}
    runs-on: ${{ matrix.runner }}
    
    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout source repository
        if: inputs.source_repo != ''
        uses: actions/checkout@71cf2267d89c5cb81562390fa70a37fa40b1305e # v4
        with:
          repository: ${{ inputs.source_repo }}
          ref: ${{ inputs.source_ref || github.ref }}
          token: ${{ secrets.source_token || github.token }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@1583c0f09d26c58c59d25b0eef29792b7ce99d9a # v3

      - name: Authenticate to Google Cloud
        if: needs.safety-checklist.outputs.is_fork_pr == 'false'
        id: auth
        uses: google-github-actions/auth@fc2174804b84f912b1f6d334e9463f484f1c552d # v3
        with:
          project_id: ${{ inputs.gcp_project_id }}
          workload_identity_provider: projects/${{ inputs.gcp_project_id }}/locations/global/workloadIdentityPools/github/providers/github-oidc
          create_credentials_file: true

      - name: Configure Docker for GCP Artifact Registry
        if: needs.safety-checklist.outputs.is_fork_pr == 'false'
        run: gcloud auth configure-docker us-docker.pkg.dev --quiet

      - name: Login to GCP Artifact Registry
        if: needs.safety-checklist.outputs.is_fork_pr == 'false'
        uses: docker/login-action@28fdb31ff34708d19615a74d67103ddc2ea9725c # v3
        with:
          registry: ${{ inputs.registry }}
          username: oauth2accesstoken
          password: ${{ steps.auth.outputs.auth_token }}

      - name: Set environment variables
        if: inputs.env != ''
        run: |
          cat >> $GITHUB_ENV << 'EOF'
          ${{ inputs.env }}
          EOF

      # === Build mode ===
      - name: Build image (build mode)
        if: inputs.mode == 'build'
        id: build
        uses: docker/build-push-action@9e436ba9f2d7bcd1d038c8e55d039d37896ddc5d # v6
        with:
          context: ${{ inputs.source_repo != '' && inputs.context || format('{{defaultContext}}:{0}', inputs.context) }}
          file: ${{ inputs.dockerfile }}
          target: ${{ inputs.target }}
          platforms: ${{ matrix.platform }}
          push: true
          provenance: mode=max
          build-args: ${{ inputs.build_args }}
          cache-from: type=gha,scope=${{ inputs.image_name }}-${{ matrix.platform }}
          cache-to: ${{ github.ref_protected && format('type=gha,mode=max,scope={0}-{1}', inputs.image_name, matrix.platform) || '' }}
          outputs: type=image,push-by-digest=true,name-canonical=true,name=${{ inputs.registry }}/${{ inputs.image_name }},push=true

      # === Bake mode ===
      - name: Build image (bake mode)
        if: inputs.mode == 'bake'
        id: bake
        env:
          PLATFORMS: ${{ matrix.platform }}
        uses: docker/bake-action@3acf805d94d93a86cce4ca44798a76464a75b88c # v6
        with:
          source: ${{ inputs.source_repo == '' && '{{defaultContext}}' || '' }}
          targets: ${{ inputs.target }}
          push: true
          files: ${{ inputs.bake_file }}
          provenance: mode=max
          set: |
            *.tags=
            *.cache-from=type=gha,scope=${{ inputs.image_name }}-${{ matrix.platform }}
            *.cache-to=${{ github.ref_protected && format('type=gha,mode=max,scope=${{ inputs.image_name }}-${{ matrix.platform }}') || '' }}
            *.output=type=image,push-by-digest=true,name-canonical=true,name=${{ inputs.registry }}/${{ inputs.image_name }},push=true
            ${{ inputs.set }}

      # === Extract digest ===
      - name: Extract digest
        run: |
          OUTPUT_FILE="/tmp/${{ inputs.image_name }}-${{ github.sha }}-${{ strategy.job-index }}.txt"
          
          if [[ "${{ inputs.mode }}" == "build" ]]; then
            cat <<'DIGEST_EOF' > "$OUTPUT_FILE"
          ${{ steps.build.outputs.digest }}
          DIGEST_EOF
          elif [[ "${{ inputs.mode }}" == "bake" ]]; then
            METADATA_FILE="${OUTPUT_FILE%.txt}-metadata.json"
            cat <<'METADATA_EOF' > "$METADATA_FILE"
          ${{ steps.bake.outputs.metadata }}
          METADATA_EOF
            jq -r '.["${{ inputs.target }}"]["containerimage.digest"]' "$METADATA_FILE" > "$OUTPUT_FILE"
          fi
          
          echo "Extracted digest: $(cat $OUTPUT_FILE)"

      - name: Upload digest
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: ${{ inputs.image_name }}-${{ github.sha }}-${{ strategy.job-index }}
          path: /tmp/${{ inputs.image_name }}-${{ github.sha }}-${{ strategy.job-index }}.txt
          if-no-files-found: error
          retention-days: 1
      
  merge:
    name: merge multi-arch manifest
    needs: [safety-checklist, build]
    runs-on: ubuntu-24.04
    outputs:
      digest: ${{ steps.merge.outputs.digest }}
    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@1583c0f09d26c58c59d25b0eef29792b7ce99d9a # v3

      - name: Authenticate to Google Cloud
        if: needs.safety-checklist.outputs.is_fork_pr == 'false'
        id: auth
        uses: google-github-actions/auth@fc2174804b84f912b1f6d334e9463f484f1c552d # v3
        with:
          project_id: ${{ inputs.gcp_project_id }}
          workload_identity_provider: projects/${{ inputs.gcp_project_id }}/locations/global/workloadIdentityPools/github/providers/github-oidc

      - name: Login to GCP Artifact Registry
        if: needs.safety-checklist.outputs.is_fork_pr == 'false'
        uses: docker/login-action@28fdb31ff34708d19615a74d67103ddc2ea9725c # v3
        with:
          registry: ${{ inputs.registry }}
          username: oauth2accesstoken
          password: ${{ steps.auth.outputs.auth_token }}

      - name: Download digests
        uses: actions/download-artifact@f093f21ca4cfa7c75ccbbc2be54da76a0c7e1f05 # v4
        with:
          path: /tmp/digests
          pattern: ${{ inputs.image_name }}-${{ github.sha }}-*
          merge-multiple: true

      - name: Create multi-arch manifest
        id: merge
        run: |
          IMAGE_NAME="${{ inputs.registry }}/${{ inputs.image_name }}"
          
          # Read digests from text files and build full references
          digest_refs=""
          for digest_file in /tmp/digests/*.txt; do
            digest=$(cat "$digest_file")
            digest_refs="$digest_refs ${IMAGE_NAME}@$digest"
          done
          
          # Create manifest from digests
          docker buildx imagetools create \
            -t ${IMAGE_NAME}:${{ github.sha }} \
            -t ${IMAGE_NAME}:${{ needs.safety-checklist.outputs.sanitized_tag }} \
            $digest_refs
          
          # Get the multi-arch manifest digest
          inspect_output=$(docker buildx imagetools inspect ${IMAGE_NAME}:${{ github.sha }})
          manifest_digest=$(echo "$inspect_output" | grep 'Digest:' | head -1 | awk '{print $2}')
          echo "digest=$manifest_digest" >> $GITHUB_OUTPUT
          
          # Extract platform info for summary
          platforms=$(echo "$inspect_output" | grep -E 'Platform:' | awk '{print $2}' | tr '\n' ', ' | sed 's/,$//')
          
          # Generate GitHub Actions summary
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ³ Multi-arch Manifest
          
          | | |
          |---|---|
          | **Image** | \`${IMAGE_NAME}\` |
          | **Digest** | \`${manifest_digest}\` |
          | **Platforms** | ${platforms} |
          
          ### Tags
          - \`${{ github.sha }}\`
          - \`${{ needs.safety-checklist.outputs.sanitized_tag }}\`
          EOF

  attest:
    name: attest build provenance
    needs: [safety-checklist, merge]
    if: needs.safety-checklist.outputs.is_fork_pr == 'false'
    runs-on: ubuntu-24.04
    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@fc2174804b84f912b1f6d334e9463f484f1c552d # v3
        with:
          project_id: ${{ inputs.gcp_project_id }}
          workload_identity_provider: projects/${{ inputs.gcp_project_id }}/locations/global/workloadIdentityPools/github/providers/github-oidc

      - name: Login to GCP Artifact Registry
        uses: docker/login-action@28fdb31ff34708d19615a74d67103ddc2ea9725c # v3
        with:
          registry: ${{ inputs.registry }}
          username: oauth2accesstoken
          password: ${{ steps.auth.outputs.auth_token }}

      - name: Attest build provenance
        uses: actions/attest-build-provenance@ba965ac88abfc6fa49344893ed19e5bf479a07d6 # v3
        with:
          subject-name: ${{ inputs.registry }}/${{ inputs.image_name }}
          subject-digest: ${{ needs.merge.outputs.digest }}
          push-to-registry: true

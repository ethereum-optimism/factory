name: Docker Build (Reusable)
# Supports both docker build and docker bake modes
# Supports both public and private repos
# Public repos: uses ubuntu-24.04-arm for native ARM builds (faster)
# Private repos: uses ubuntu-latest with QEMU for ARM (set use_arm_runners: false)

on:
  workflow_call:
    inputs:
      # === Common inputs ===
      mode:
        description: 'Build mode: "build" for Dockerfile, "bake" for docker-bake.hcl'
        required: false
        type: string
        default: 'build'
      registry:
        description: 'Container registry URL (e.g., us-docker.pkg.dev/project/repo)'
        required: true
        type: string
      image_name:
        description: 'Image name (e.g., gateway-backend)'
        required: true
        type: string
      target:
        description: 'Docker build target (for multi-stage Dockerfiles) or bake target'
        required: false
        type: string
        default: ''
      gcp_project_id:
        description: 'GCP Project ID'
        required: false
        type: string
      tag:
        description: 'Docker tag for the final image'
        required: false
        type: string
        default: ${{ github.ref_name }}
      use_arm_runners:
        description: 'Use native ARM runners (only works in public repos)'
        required: false
        type: boolean
        default: true
      env:
        description: 'Environment variables to set before build (KEY=VALUE format, one per line)'
        required: false
        type: string
        default: ''

      # === Build mode inputs ===
      context:
        description: '[build mode] Build context path'
        required: false
        default: '.'
        type: string
      dockerfile:
        description: '[build mode] Path to Dockerfile relative to context'
        required: false
        type: string
        default: 'Dockerfile'
      build_args:
        description: '[build mode] Build arguments as multiline string (KEY=VALUE format, one per line)'
        required: false
        type: string
        default: ''

      # === Bake mode inputs ===
      bake_file:
        description: '[bake mode] Path to docker-bake.hcl or docker-compose.yml file'
        required: false
        type: string
        default: 'docker-bake.hcl'
      set:
        description: '[bake mode] Variables to set (KEY=VALUE format, one per line)'
        required: false
        type: string
        default: ''

jobs:
  prep:
    runs-on: ubuntu-latest
    outputs:
      sanitized_tag: ${{ steps.sanitize.outputs.sanitized_tag }}
      is_fork_pr: ${{ steps.fork-check.outputs.is_fork_pr }}
    steps:
      - uses: ./actions/harden
      - name: Sanitize tag
        id: sanitize
        run: echo "sanitized_tag=$(echo ${{ inputs.tag }} | sed 's/[^a-zA-Z0-9.]/-/g')" >> $GITHUB_OUTPUT
      - name: Check if we are in a fork PR
        id: fork-check
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" && "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]]; then
            echo "is_fork_pr=true" >> $GITHUB_OUTPUT
          else
            echo "is_fork_pr=false" >> $GITHUB_OUTPUT
          fi

  build:
    needs: prep
    strategy:
      fail-fast: true
      matrix:
        include:
        - platform: linux/amd64
          runner: ubuntu-latest
        - platform: linux/arm64
          runner: ${{ inputs.use_arm_runners && 'ubuntu-24.04-arm' || 'ubuntu-latest' }}
    runs-on: ${{ matrix.runner }}
    
    steps:
      - uses: ./actions/harden
      - uses: ./actions/docker-setup
        with:
          use_qemu: ${{ !inputs.use_arm_runners }}
      - uses: ./actions/gcp-docker-auth
        if: needs.prep.outputs.is_fork_pr == 'false'
        with:
          gcp_project_id: ${{ inputs.gcp_project_id }}

      - name: Set environment variables
        if: inputs.env != ''
        run: |
          cat >> $GITHUB_ENV << 'EOF'
          ${{ inputs.env }}
          EOF

      # === Build mode ===
      - name: Build image (build mode)
        if: inputs.mode == 'build'
        id: build
        uses: docker/build-push-action@9e436ba9f2d7bcd1d038c8e55d039d37896ddc5d # v6
        with:
          context: "{{defaultContext}}:${{ inputs.context }}"
          file: ${{ inputs.dockerfile }}
          target: ${{ inputs.target }}
          platforms: ${{ matrix.platform }}
          push: true
          provenance: mode=max
          build-args: ${{ inputs.build_args }}
          cache-from: type=gha,scope=${{ inputs.image_name }}-${{ matrix.platform }}
          cache-to: ${{ github.ref_protected && format('type=gha,mode=max,scope={0}-{1}', inputs.image_name, matrix.platform) || '' }}
          outputs: type=image,push-by-digest=true,name-canonical=true,name=${{ inputs.registry }}/${{ inputs.image_name }},push=true

      # === Bake mode ===
      - name: Build image (bake mode)
        if: inputs.mode == 'bake'
        id: bake
        env:
          PLATFORMS: ${{ matrix.platform }}
        uses: docker/bake-action@3acf805d94d93a86cce4ca44798a76464a75b88c # v6
        with:
          targets: ${{ inputs.target }}
          push: true
          files: ${{ inputs.bake_file }}
          provenance: mode=max
          set: |
            *.tags=
            *.cache-from=type=gha,scope=${{ inputs.image_name }}-${{ matrix.platform }}
            *.cache-to=${{ github.ref_protected && format('type=gha,mode=max,scope=${{ inputs.image_name }}-${{ matrix.platform }}') || '' }}
            *.output=type=image,push-by-digest=true,name-canonical=true,name=${{ inputs.registry }}/${{ inputs.image_name }},push=true
            ${{ inputs.set }}

      # === Common ===
      - uses: ./actions/extract-docker-digest
        with:
          mode: ${{ inputs.mode }}
          build_digest: ${{ steps.build.outputs.digest }}
          bake_metadata: ${{ steps.bake.outputs.metadata }}
          bake_target: ${{ inputs.target }}
          output_file: /tmp/${{ inputs.image_name }}-${{ github.sha }}-${{ strategy.job-index }}.txt

      - name: Upload digest
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: ${{ inputs.image_name }}-${{ github.sha }}-${{ strategy.job-index }}
          path: /tmp/${{ inputs.image_name }}-${{ github.sha }}-${{ strategy.job-index }}.txt
          if-no-files-found: error
          retention-days: 1
      
  merge:
    name: merge multi-arch manifest
    needs: [prep, build]
    runs-on: ubuntu-24.04
    outputs:
      digest: ${{ steps.merge.outputs.digest }}
    steps:
      - uses: ./actions/harden
      - uses: ./actions/docker-setup
      - uses: ./actions/gcp-docker-auth
        if: needs.prep.outputs.is_fork_pr == 'false'
        with:
          gcp_project_id: ${{ inputs.gcp_project_id }}

      - name: Download digests
        uses: actions/download-artifact@f093f21ca4cfa7c75ccbbc2be54da76a0c7e1f05 # v4
        with:
          path: /tmp/digests
          pattern: ${{ inputs.image_name }}-${{ github.sha }}-*
          merge-multiple: true

      - uses: ./actions/merge-multi-arch-docker-images
        id: merge
        with:
          registry: ${{ inputs.registry }}
          image_name: ${{ inputs.image_name }}
          tag: ${{ needs.prep.outputs.sanitized_tag }}

  attest:
    name: attest build provenance
    needs: [prep, build,merge]
    if: needs.prep.outputs.is_fork_pr == 'false'
    runs-on: ubuntu-24.04
    steps:
      - uses: ./actions/harden
      - uses: ./actions/docker-setup
      - uses: ./actions/gcp-docker-auth
        with:
          gcp_project_id: ${{ inputs.gcp_project_id }}

      - name: Attest build provenance
        uses: actions/attest-build-provenance@ba965ac88abfc6fa49344893ed19e5bf479a07d6 # v3
        with:
          subject-name: ${{ inputs.registry }}/${{ inputs.image_name }}
          subject-digest: ${{ needs.merge.outputs.digest }}
          push-to-registry: true

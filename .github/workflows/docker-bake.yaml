name: Bake + Attest
# Only works in public repos
# ubuntu-24.04-arm is only available in public repositories

on:
  workflow_call:
    inputs:
      image_name:
        description: 'Image name (e.g., gateway-backend)'
        required: true
        type: string
      context:
        description: 'Build context path'
        required: false
        default: '.'
        type: string
      bake_file:
        description: 'Path to docker-bake.hcl or docker-compose.yml file'
        required: false
        type: string
        default: 'docker-bake.hcl'
      target:
        description: 'Bake target to build'
        required: false
        type: string
        default: ''
      gcp_project_id:
        description: 'GCP Project ID'
        required: true
        type: string
      gcp_registry:
        description: 'Container registry URL (e.g., us-docker.pkg.dev/project/repo)'
        required: true
        type: string
      set:
        description: 'Variables to set (KEY=VALUE format, one per line)'
        required: false
        type: string
        default: ''
      git_version:
        description: 'GIT_VERSION to set as environment variable for bake'
        required: false
        type: string
        default: ''
      tag:
        description: 'Docker tag for the final image'
        required: false
        type: string
        default: ''

jobs:
  bake:
    strategy:
      fail-fast: true
      matrix:
        include:
        - platform: linux/amd64
          runner: ubuntu-latest
        - platform: linux/arm64
          runner: ubuntu-24.04-arm
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: harden-runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@71cf2267d89c5cb81562390fa70a37fa40b1305e # v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@1583c0f09d26c58c59d25b0eef29792b7ce99d9a # v3
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@fc2174804b84f912b1f6d334e9463f484f1c552d # v3
        with:
          project_id: ${{ inputs.gcp_project_id }}
          workload_identity_provider: projects/${{ inputs.gcp_project_id }}/locations/global/workloadIdentityPools/github/providers/github-oidc
          create_credentials_file: true
      - name: Configure Docker for GCP Artifact Registry
        run: gcloud auth configure-docker us-docker.pkg.dev --quiet

      - name: Bake architecture specific image
        id: bake
        env:
          GIT_VERSION: ${{ inputs.git_version }}
          PLATFORMS: ${{ matrix.platform }}
        uses: docker/bake-action@3acf805d94d93a86cce4ca44798a76464a75b88c # v6
        with:
          targets: ${{ inputs.target }}
          push: true
          files: ${{ inputs.bake_file }}
          set: |
            *.tags=
            *.output=type=image,push-by-digest=true,name-canonical=true,name=${{ inputs.gcp_registry }}/${{ inputs.image_name }},push=true
            ${{ inputs.set }}

      - name: Store build metadata in temporary file
        run: echo "${{ steps.bake.outputs.metadata }}" > /tmp/${{ github.sha }}.json

      - name: Upload build metadata
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: ${{ github.sha }}-${{ strategy.job-index }}
          path: /tmp/${{ github.sha }}.json
          if-no-files-found: error
          retention-days: 1
      
  attest:
    name: Attest multi-arch manifest
    needs: bake
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      id-token: write
      attestations: write
    steps:
      - name: harden-runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2
        with:
          egress-policy: audit
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@1583c0f09d26c58c59d25b0eef29792b7ce99d9a # v3

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@fc2174804b84f912b1f6d334e9463f484f1c552d # v3
        with:
          project_id: ${{ inputs.gcp_project_id }}
          workload_identity_provider: projects/${{ inputs.gcp_project_id }}/locations/global/workloadIdentityPools/github/providers/github-oidc

      - name: Login to Artifact Registry
        uses: docker/login-action@28fdb31ff34708d19615a74d67103ddc2ea9725c # v3
        with:
          registry: ${{ inputs.gcp_registry }}
          username: oauth2accesstoken
          password: ${{ steps.auth.outputs.auth_token }}

      - name: Download digests
        uses: actions/download-artifact@f093f21ca4cfa7c75ccbbc2be54da76a0c7e1f05 # v6
        with:
          path: /tmp/
          pattern: ${{ github.sha }}-*
          merge-multiple: true

      - name: Create multi-arch manifest
        id: merge
        run: |
          # Extract digests from metadata JSON files
          digests=""
          for json_file in /tmp/${{ github.sha }}*.json; do
            digest=$(jq -c -r '.["${{ inputs.target }}"]["containerimage.digest"]' "$json_file")
            digests="$digests $digest"
          done
          
          # Create manifest from digests
          docker buildx imagetools create \
            -t ${{ inputs.gcp_registry }}/${{ inputs.image_name }}:${{ github.sha }} \
            -t ${{ inputs.gcp_registry }}/${{ inputs.image_name }}:${{ inputs.tag }} \
            $digests
          
          # Get the multi-arch manifest digest
          manifest_digest=$(docker buildx imagetools inspect ${IMAGE_NAME}:${{ github.sha }} --format '{{.Manifest.Digest}}')
          echo "digest=$manifest_digest" >> $GITHUB_OUTPUT
          echo "Multi-arch manifest digest: $manifest_digest"
    
      - name: Attest build provenance
        uses: actions/attest-build-provenance@ba965ac88abfc6fa49344893ed19e5bf479a07d6 # v3
        with:
          subject-name: ${{ inputs.gcp_registry }}/${{ inputs.image_name }}
          subject-digest: ${{ steps.merge.outputs.digest }}
          push-to-registry: true

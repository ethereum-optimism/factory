name: Bake + Attest
# Only works in public repos
# ubuntu-24.04-arm is only available in public repositories

on:
  workflow_call:
    inputs:
      image_name:
        description: 'Image name (e.g., gateway-backend)'
        required: true
        type: string
      context:
        description: 'Build context path'
        required: false
        default: '.'
        type: string
      bake_file:
        description: 'Path to docker-bake.hcl or docker-compose.yml file'
        required: false
        type: string
        default: 'docker-bake.hcl'
      target:
        description: 'Bake target to build'
        required: false
        type: string
        default: ''
      gcp_project_id:
        description: 'GCP Project ID'
        required: true
        type: string
      gcp_registry:
        description: 'Container registry URL (e.g., us-docker.pkg.dev/project/repo)'
        required: true
        type: string
      set:
        description: 'Variables to set (KEY=VALUE format, one per line)'
        required: false
        type: string
        default: ''
      git_version:
        description: 'GIT_VERSION to set as environment variable for bake'
        required: false
        type: string
        default: ''
      tag:
        description: 'Docker tag for the final image'
        required: false
        type: string
        default: ''

jobs:
  bake:
    strategy:
      fail-fast: true
      matrix:
        include:
        - platform: linux/amd64
          runner: ubuntu-latest
        - platform: linux/arm64
          runner: ubuntu-24.04-arm
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: harden-runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@71cf2267d89c5cb81562390fa70a37fa40b1305e # v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@1583c0f09d26c58c59d25b0eef29792b7ce99d9a # v3
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@fc2174804b84f912b1f6d334e9463f484f1c552d # v3
        with:
          project_id: ${{ inputs.gcp_project_id }}
          workload_identity_provider: projects/${{ inputs.gcp_project_id }}/locations/global/workloadIdentityPools/github/providers/github-oidc
          create_credentials_file: true
      - name: Configure Docker for GCP Artifact Registry
        run: gcloud auth configure-docker us-docker.pkg.dev --quiet

      - name: Bake architecture specific image
        env:
          GIT_VERSION: ${{ inputs.git_version }}
        uses: docker/bake-action@3acf805d94d93a86cce4ca44798a76464a75b88c # v6
        with:
          targets: ${{ inputs.target }}
          push: true
          files: ${{ inputs.bake_file }}
          set: |
            *.tags=${{ inputs.gcp_registry }}/${{ inputs.image_name }}:${{ github.sha }}-${{ matrix.platform }}
            *.platforms=${{ matrix.platform }}
            ${{ inputs.set }}

  attest:
    needs: bake
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      id-token: write
      attestations: write
    steps:
      - name: harden-runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2
        with:
          egress-policy: audit
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@1583c0f09d26c58c59d25b0eef29792b7ce99d9a # v3

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@fc2174804b84f912b1f6d334e9463f484f1c552d # v3
        with:
          project_id: ${{ inputs.gcp_project_id }}
          workload_identity_provider: projects/${{ inputs.gcp_project_id }}/locations/global/workloadIdentityPools/github/providers/github-oidc

      - name: Login to Artifact Registry
        uses: docker/login-action@28fdb31ff34708d19615a74d67103ddc2ea9725c # v3
        with:
          registry: ${{ inputs.gcp_registry }}
          username: oauth2accesstoken
          password: ${{ steps.auth.outputs.auth_token }}

      - name: Create multi-arch manifest & get digest
        id: merge
        run: |
          docker buildx imagetools create \
            -t us-docker.pkg.dev/oplabs-tools-artifacts/oss/${{ inputs.image_name }}:${{ github.sha }} \
            -t us-docker.pkg.dev/oplabs-tools-artifacts/oss/${{ inputs.image_name }}:${{ inputs.tag }} \
            us-docker.pkg.dev/oplabs-tools-artifacts/oss/${{ inputs.image_name }}:${{ github.sha }}-amd64 \
            us-docker.pkg.dev/oplabs-tools-artifacts/oss/${{ inputs.image_name }}:${{ github.sha }}-arm64
          
          # Get the multi arch manifest digest
          digest=$(docker buildx imagetools inspect us-docker.pkg.dev/oplabs-tools-artifacts/oss/${{ inputs.image_name }}:${{ github.sha }} --format '{{.Manifest.Digest}}')
          echo "digest=$digest" >> $GITHUB_OUTPUT
          echo "Multi Arch Manifest digest: $digest"
    
      - name: Attest build provenance
        uses: actions/attest-build-provenance@ba965ac88abfc6fa49344893ed19e5bf479a07d6 # v3
        with:
          subject-name: ${{ inputs.gcp_registry }}/${{ inputs.image_name }}
          subject-digest: ${{ steps.merge.outputs.digest }}
          push-to-registry: true

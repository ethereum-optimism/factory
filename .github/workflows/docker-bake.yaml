name: Build with Docker Bake (Reusable)

on:
  workflow_call:
    inputs:
      image_name:
        description: 'Image name (e.g., gateway-backend)'
        required: true
        type: string
      context:
        description: 'Build context path'
        required: false
        default: '.'
        type: string
      platforms:
        description: 'Comma-separated list of platforms (e.g., linux/amd64,linux/arm64)'
        default: 'linux/amd64,linux/arm64'
        required: false
        type: string
      bake_file:
        description: 'Path to docker-bake.hcl or docker-compose.yml file'
        required: false
        type: string
        default: 'docker-bake.hcl'
      target:
        description: 'Bake target to build'
        required: false
        type: string
        default: ''
      gcp_project_id:
        description: 'GCP Project ID'
        required: true
        type: string
      gcp_registry:
        description: 'Container registry URL (e.g., us-docker.pkg.dev/project/repo)'
        required: true
        type: string
      set:
        description: 'Variables to set (KEY=VALUE format, one per line)'
        required: false
        type: string
        default: ''
      runs_on:
        description: 'Runner to use (e.g., ubuntu-24.04, ubuntu-24.04-arm)'
        required: false
        type: string
        default: 'ubuntu-24.04'

jobs:
  build:
    runs-on: ${{ inputs.runs_on }}
    permissions:
      contents: read
      id-token: write
      attestations: write
    
    steps:
      - name: harden-runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@71cf2267d89c5cb81562390fa70a37fa40b1305e # v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@1583c0f09d26c58c59d25b0eef29792b7ce99d9a # v3
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@fc2174804b84f912b1f6d334e9463f484f1c552d # v3
        with:
          project_id: ${{ inputs.gcp_project_id }}
          workload_identity_provider: projects/${{ inputs.gcp_project_id }}/locations/global/workloadIdentityPools/github/providers/github-oidc
          create_credentials_file: true
      - name: Configure Docker for GCP Artifact Registry
        run: gcloud auth configure-docker us-docker.pkg.dev --quiet

      - name: Build and push image
        id: build
        uses: docker/bake-action@3acf805d94d93a86cce4ca44798a76464a75b88c # v6
        with:
          source: .
          targets: ${{ inputs.target }}
          push: true
          files: |
            ${{ inputs.bake_file }}
          set: |
            ${{ inputs.set }}

      - name: Extract digest
        id: digest
        run: |
          echo '${{ steps.build.outputs.metadata }}' | jq .
          digest=$(echo '${{ steps.build.outputs.metadata }}' | jq -r '.["${{ inputs.target }}"]["containerimage.digest"]')
          echo "digest=$digest" >> $GITHUB_OUTPUT

      # reauthentication is necessary because
      # 1. the actions/attest-build-provenance does not use the gcloud cred helper
      # 2. the first google-github-actions/auth outputs.auth_token may have expired (5 minutes lifetime)
      - run: rm ~/.docker/config.json
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@fc2174804b84f912b1f6d334e9463f484f1c552d # v3
        with:
          project_id: ${{ inputs.gcp_project_id }}
          workload_identity_provider: projects/${{ inputs.gcp_project_id }}/locations/global/workloadIdentityPools/github/providers/github-oidc
      - name: Login to Artifact Registry
        uses: docker/login-action@28fdb31ff34708d19615a74d67103ddc2ea9725c # v3
        with:
          registry: ${{ inputs.gcp_registry }}
          username: oauth2accesstoken
          password: ${{ steps.auth.outputs.auth_token }}
    
      - name: Attest build provenance
        uses: actions/attest-build-provenance@ba965ac88abfc6fa49344893ed19e5bf479a07d6 # v3
        with:
          subject-name: ${{ inputs.gcp_registry }}/${{ inputs.image_name }}
          subject-digest: ${{ steps.digest.outputs.digest }}
          push-to-registry: true
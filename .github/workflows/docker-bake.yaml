name: Build with Docker Bake (Reusable)

on:
  workflow_call:
    inputs:
      image_name:
        description: 'Image name (e.g., gateway-backend)'
        required: true
        type: string
      context:
        description: 'Build context path'
        required: false
        default: '.'
        type: string
      platforms:
        description: 'Comma-separated list of platforms (e.g., linux/amd64,linux/arm64)'
        default: 'linux/amd64,linux/arm64'
        required: false
        type: string
      bake_file:
        description: 'Path to docker-bake.hcl or docker-compose.yml file'
        required: false
        type: string
        default: 'docker-bake.hcl'
      targets:
        description: 'Comma-separated list of bake targets to build'
        required: false
        type: string
        default: ''
      extraTags:
        description: 'Additional tags (type=raw format). Default tags (type=sha, type=ref) are always included'
        required: false
        type: string
        default: ''
      gcp_project_id:
        description: 'GCP Project ID'
        required: true
        type: string
      gcp_registry:
        description: 'Container registry URL (e.g., us-docker.pkg.dev/project/repo)'
        required: true
        type: string
      set:
        description: 'Variables to set (KEY=VALUE format, one per line)'
        required: false
        type: string
        default: ''

jobs:
  build:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      id-token: write
      attestations: write
    
    steps:
      - name: harden-runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@71cf2267d89c5cb81562390fa70a37fa40b1305e # v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@1583c0f09d26c58c59d25b0eef29792b7ce99d9a # v3
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@fc2174804b84f912b1f6d334e9463f484f1c552d # v3
        with:
          project_id: ${{ inputs.gcp_project_id }}
          workload_identity_provider: projects/${{ inputs.gcp_project_id }}/locations/global/workloadIdentityPools/github/providers/github-oidc
          create_credentials_file: true
      - name: Configure Docker for GCP Artifact Registry
        run: gcloud auth configure-docker us-docker.pkg.dev --quiet

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@8d8c7c12f7b958582a5cb82ba16d5903cb27976a # v5
        with:
          images: ${{ inputs.gcp_registry }}/${{ inputs.image_name }}
          tags: |
            type=sha
            type=sha,format=long,prefix=
            type=ref,event=branch
            type=ref,event=tag
            ${{ inputs.extraTags }}

      - name: Print tags
        run: cat ${{ steps.meta.outputs.bake-file-tags }}

      - name: Build and push image
        id: build
        uses: docker/bake-action@3acf805d94d93a86cce4ca44798a76464a75b88c # v6
        with:
          targets: ${{ inputs.targets }}
          push: true
          files: |
            ${{ inputs.bake_file }}
            ${{ steps.meta.outputs.bake-file-tags }}
          set: |
            ${{ inputs.set }}

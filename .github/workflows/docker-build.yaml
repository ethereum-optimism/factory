name: Build with Docker Build (Reusable)
# Supports both public and private repos
# Public repos: uses ubuntu-24.04-arm for native ARM builds (faster)
# Private repos: uses ubuntu-latest with QEMU for ARM (set use_arm_runners: false)

on:
  workflow_call:
    inputs:
      registry:
        description: 'Container registry URL (e.g., us-docker.pkg.dev/project/repo)'
        required: true
        type: string
      image_name:
        description: 'Image name (e.g., gateway-backend)'
        required: true
        type: string
      context:
        description: 'Build context path'
        required: false
        default: '.'
        type: string
      dockerfile:
        description: 'Path to Dockerfile relative to context'
        required: false
        type: string
        default: 'Dockerfile'
      target:
        description: 'Docker build target (for multi-stage Dockerfiles)'
        required: false
        type: string
        default: ''
      gcp_project_id:
        description: 'GCP Project ID'
        required: false
        type: string
      build_args:
        description: 'Build arguments as multiline string (KEY=VALUE format, one per line)'
        required: false
        type: string
        default: ''
      tag:
        description: 'Docker tag for the final image'
        required: false
        type: string
        default: ${{ github.ref_name }}
      use_arm_runners:
        description: 'Use native ARM runners (only works in public repos)'
        required: false
        type: boolean
        default: true
      attest:
        description: 'Attest build provenance and push to registry'
        required: false
        type: boolean
        default: true

jobs:
  sanitize:
    runs-on: ubuntu-latest
    outputs:
      sanitized_ref_name: ${{ steps.sanitize.outputs.ref_name }}
    steps:
      - name: Sanitize ref_name
        id: sanitize
        run: echo "ref_name=$(echo ${{ github.ref_name }} | sed 's/[^a-zA-Z0-9.]/-/g')" >> $GITHUB_OUTPUT

  build:
    strategy:
      fail-fast: true
      matrix:
        include:
        - platform: linux/amd64
          runner: ubuntu-latest
        - platform: linux/arm64
          runner: ${{ inputs.use_arm_runners && 'ubuntu-24.04-arm' || 'ubuntu-latest' }}
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: harden-runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@71cf2267d89c5cb81562390fa70a37fa40b1305e # v4

      - name: Set up QEMU
        if: ${{ !inputs.use_arm_runners }}
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@1583c0f09d26c58c59d25b0eef29792b7ce99d9a # v3
      
      - name: Authenticate to Google Cloud
        if: inputs.gcp_project_id != ''
        uses: google-github-actions/auth@fc2174804b84f912b1f6d334e9463f484f1c552d # v3
        with:
          project_id: ${{ inputs.gcp_project_id }}
          workload_identity_provider: projects/${{ inputs.gcp_project_id }}/locations/global/workloadIdentityPools/github/providers/github-oidc
          create_credentials_file: true
      - name: Configure Docker for GCP Artifact Registry
        if: inputs.gcp_project_id != ''
        run: gcloud auth configure-docker us-docker.pkg.dev --quiet

      - name: Build architecture specific image
        id: build
        uses: docker/build-push-action@9e436ba9f2d7bcd1d038c8e55d039d37896ddc5d # v6
        with:
          context: ${{ inputs.context }}
          file: ${{ inputs.dockerfile }}
          target: ${{ inputs.target }}
          platforms: ${{ matrix.platform }}
          push: true
          provenance: mode=max
          build-args: ${{ inputs.build_args }}
          cache-from: type=gha,scope=${{ inputs.image_name }}-${{ matrix.platform }}
          cache-to: ${{ github.ref_protected && format('type=gha,mode=max,scope={0}-{1}', inputs.image_name, matrix.platform) || '' }}
          outputs: type=image,push-by-digest=true,name-canonical=true,name=${{ inputs.registry }}/${{ inputs.image_name }},push=true

      - name: Extract digest from metadata
        run: |
          echo '${{ steps.build.outputs.digest }}' > /tmp/${{ inputs.image_name }}-${{ github.sha }}-${{ strategy.job-index }}.txt
          cat /tmp/${{ inputs.image_name }}-${{ github.sha }}-${{ strategy.job-index }}.txt

      - name: Upload digest
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: ${{ inputs.image_name }}-${{ github.sha }}-${{ strategy.job-index }}
          path: /tmp/${{ inputs.image_name }}-${{ github.sha }}-${{ strategy.job-index }}.txt
          if-no-files-found: error
          retention-days: 1
      
  merge:
    name: merge multi-arch manifest & attest it
    needs: [build, sanitize]
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      id-token: write
      attestations: write
    steps:
      - name: harden-runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2
        with:
          egress-policy: audit
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@1583c0f09d26c58c59d25b0eef29792b7ce99d9a # v3

      - name: Authenticate to Google Cloud
        if: inputs.gcp_project_id != ''
        id: auth
        uses: google-github-actions/auth@fc2174804b84f912b1f6d334e9463f484f1c552d # v3
        with:
          project_id: ${{ inputs.gcp_project_id }}
          workload_identity_provider: projects/${{ inputs.gcp_project_id }}/locations/global/workloadIdentityPools/github/providers/github-oidc

      - name: Login to GCP Artifact Registry
        if: inputs.gcp_project_id != ''
        uses: docker/login-action@28fdb31ff34708d19615a74d67103ddc2ea9725c # v3
        with:
          registry: ${{ inputs.registry }}
          username: oauth2accesstoken
          password: ${{ steps.auth.outputs.auth_token }}

      - name: Download digests
        uses: actions/download-artifact@f093f21ca4cfa7c75ccbbc2be54da76a0c7e1f05 # v4
        with:
          path: /tmp/digests
          pattern: ${{ inputs.image_name }}-${{ github.sha }}-*
          merge-multiple: true

      - name: Create multi-arch manifest
        id: merge
        run: |
          IMAGE_NAME="${{ inputs.registry }}/${{ inputs.image_name }}"
          
          # Read digests from text files and build full references
          digest_refs=""
          for digest_file in /tmp/digests/*.txt; do
            digest=$(cat "$digest_file")
            digest_refs="$digest_refs ${IMAGE_NAME}@$digest"
          done
          
          # Create manifest from digests
          docker buildx imagetools create \
            -t ${IMAGE_NAME}:${{ github.sha }} \
            -t ${IMAGE_NAME}:${{ needs.sanitize.outputs.sanitized_ref_name }} \
            $digest_refs
          
          # Get the multi-arch manifest digest
          manifest_digest=$(docker buildx imagetools inspect ${IMAGE_NAME}:${{ github.sha }} | grep 'Digest:' | head -1 | awk '{print $2}')
          echo "digest=$manifest_digest" >> $GITHUB_OUTPUT
          echo "Multi-arch manifest digest: $manifest_digest"
    
      - name: Attest build provenance
        if: inputs.attest
        uses: actions/attest-build-provenance@ba965ac88abfc6fa49344893ed19e5bf479a07d6 # v3
        with:
          subject-name: ${{ inputs.registry }}/${{ inputs.image_name }}
          subject-digest: ${{ steps.merge.outputs.digest }}
          push-to-registry: true
